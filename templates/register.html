{% extends 'base.html' %}
{% load static %}

{% block title %}创建账号{% endblock %}

{% block bootstrap_css %}{% endblock %}
{% block bootstrap_scripts %}{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/auth.css' %}">
{% endblock %}

{% block content %}
<div class="auth-wrapper">
  <div class="auth-card">
    <div class="auth-header">
      <h1 class="auth-title">创建您的账号</h1>
      <p class="auth-sub">欢迎使用 Takagi AI</p>
    </div>
    
    {% if error_message %}
      <div class="alert">{{ error_message }}</div>
    {% endif %}

    <form method="post" id="register-form">
      {% csrf_token %}
      <div class="form-group">
        <label for="username">用户名</label>
        <input type="text" class="form-control" id="username" name="username" value="{{ prefill_username|default:'' }}" required autocomplete="username">
      </div>
      
      <div class="form-group">
        <label for="email">邮箱</label>
        <div class="dual-inline">
          <input type="email" class="form-control" id="email" name="email" value="{{ prefill_email|default:'' }}" required autocomplete="email">
          <button class="btn btn-secondary" type="button" id="send-code-btn">发送验证码</button>
        </div>
        <div class="code-sent" id="code-sent-msg">验证码已发送，请查收。</div>
      </div>
      
      <div class="form-group">
        <label for="email_code">邮箱验证码</label>
        <input type="text" class="form-control" id="email_code" name="email_code" maxlength="6" required>
      </div>
      
      <div class="form-group password-group">
        <label for="password">密码</label>
        <input type="password" class="form-control" id="password" name="password1" required autocomplete="new-password">
        <span class="pwd-toggle" id="pwd-toggle">显示</span>
        <div class="pwd-meter"><div class="pwd-meter-bar" id="pwd-meter-bar"></div></div>
        <div class="pwd-hint" id="pwd-hint">至少 8 位，包含字母和数字。</div>
      </div>
      
      <div class="form-group">
        <label for="password2">确认密码</label>
        <input type="password" class="form-control" id="password2" name="password2" required autocomplete="new-password">
      </div>
      
      <button type="submit" class="btn btn-primary">立即注册</button>
      
      <div class="switch-link">
        已有账号？ <a href="{% url 'login' %}">点此登录</a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script defer>
document.addEventListener('DOMContentLoaded', function() {
    const pwdInput = document.getElementById('password');
    const pwdMeterBar = document.getElementById('pwd-meter-bar');
    const pwdHint = document.getElementById('pwd-hint');
    const usernameInput = document.getElementById('username');
    const emailInput = document.getElementById('email');

    function assessPassword(v) {
        let score = 0;
        if (v.length >= 8) score++;
        if (/[a-z]/.test(v) && /[A-Z]/.test(v)) score++;
        if (/\d/.test(v)) score++;
        if (/[^\w\s]/.test(v)) score++;
        if (v.length >= 12) score++;
        return score;
    }

    function updatePasswordStrengthUI(score, text = null) {
        const percent = (score / 5) * 100;
        pwdMeterBar.style.width = percent + '%';
        
        pwdMeterBar.classList.remove('strength-1', 'strength-2', 'strength-3', 'strength-4');
        if (score > 0) {
            pwdMeterBar.classList.add(`strength-${Math.min(score, 4)}`);
        }

        if (text) {
            pwdHint.textContent = text;
            pwdHint.style.color = '';
        } else {
            const levels = ['很弱', '较弱', '一般', '较强', '非常强'];
            pwdHint.textContent = pwdInput.value ? ('密码强度: ' + (levels[score-1] || '很弱')) : '至少 8 位，包含字母和数字。';
            pwdHint.style.color = '';
        }
    }

    let pwdValidationTimer = null;
    pwdInput.addEventListener('input', () => {
        const value = pwdInput.value;
        const score = assessPassword(value);
        updatePasswordStrengthUI(score);
        
        clearTimeout(pwdValidationTimer);
        pwdValidationTimer = setTimeout(validatePasswordWithBackend, 400);
    });

    function validatePasswordWithBackend() {
        const password = pwdInput.value;
        if (!password) return;

        const formData = new URLSearchParams();
        formData.append('password', password);
        formData.append('username', usernameInput.value.trim());
        formData.append('email', emailInput.value.trim());

        fetch('/register/pwd_validate', {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            if (!data.ok) {
                pwdHint.textContent = '密码问题: ' + data.errors.join(' / ');
                pwdHint.style.color = 'var(--color-error)';
            } else {
                updatePasswordStrengthUI(data.score, '密码强度: ' + data.level);
                pwdHint.style.color = '#16a34a';
            }
        }).catch(() => { /* Gracefully handle fetch errors */ });
    }

    const sendCodeBtn = document.getElementById('send-code-btn');
    const codeSentMsg = document.getElementById('code-sent-msg');
    let countdown = 0;
    let countdownTimer = null;

    function updateCountdown() {
        if (countdown <= 0) {
            clearInterval(countdownTimer);
            sendCodeBtn.disabled = false;
            sendCodeBtn.textContent = '发送验证码';
            return;
        }
        sendCodeBtn.textContent = `重新发送(${countdown}s)`;
        countdown--;
    }

    const emailRegex = /^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/;
    let isSendingCode = false;

    sendCodeBtn.addEventListener('click', () => {
        if (isSendingCode) return;

        const email = emailInput.value.trim();
        if (!email) {
            alert('请输入邮箱地址。');
            return;
        }
        if (!emailRegex.test(email)) {
            alert('邮箱格式不正确，请检查。');
            return;
        }

        isSendingCode = true;
        sendCodeBtn.disabled = true;
        sendCodeBtn.textContent = '发送中...';

        fetch('/register/send_code', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: 'email=' + encodeURIComponent(email)
        })
        .then(r => r.json())
        .then(data => {
            if (data.ok) {
                codeSentMsg.style.display = 'block';
                countdown = 60;
                updateCountdown();
                countdownTimer = setInterval(updateCountdown, 1000);
            } else {
                alert(data.error || '验证码发送失败，请稍后再试。');
                sendCodeBtn.disabled = false;
                sendCodeBtn.textContent = '发送验证码';
            }
        })
        .catch(() => {
            alert('网络请求失败，请检查您的网络连接。');
            sendCodeBtn.disabled = false;
            sendCodeBtn.textContent = '发送验证码';
        })
        .finally(() => {
            setTimeout(() => { isSendingCode = false; }, 600);
        });
    });

    const pwdToggle = document.getElementById('pwd-toggle');
    pwdToggle.addEventListener('click', () => {
        if (pwdInput.type === 'password') {
            pwdInput.type = 'text';
            pwdToggle.textContent = '隐藏';
        } else {
            pwdInput.type = 'password';
            pwdToggle.textContent = '显示';
        }
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}