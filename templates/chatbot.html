{% extends 'base.html' %}
{% load static avatar_extras %}
{% block title %}AI Takagi{% endblock %}

{% block bootstrap_css %}{% endblock %}
{% block bootstrap_scripts %}{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}">
<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.tts-play-btn:hover {
    background: #0056b3 !important;
    transform: translateY(-1px);
}

.tts-loader {
    opacity: 0.8;
}
</style>
{% endblock %}


{% block content %}
<div class="chat-container">
    {% if user.is_authenticated %}
    <header class="chat-header">
        <div class="brand">
            <img src="{% static 'img/icon/TakagiW.webp' %}" alt="Takagi">
            <span>æ¬¢è¿, {{ user.username }}</span>
        </div>
        <div class="header-spacer"></div>
        <button id="chatHistoryButton" class="icon-btn" aria-expanded="false" aria-controls="chatHistoryPanel" aria-label="èŠå¤©è®°å½•" title="èŠå¤©è®°å½•">
            <svg viewBox="0 0 24 24" role="img" aria-hidden="true"><path fill="currentColor" d="M4 4h16v12H5.17L4 17.17V4m0-2a2 2 0 0 0-2 2v18l4-4h14a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H4Z"/></svg>
        </button>
        <div class="avatar-wrapper" style="position:relative;">
            <button id="avatarMenuToggle" class="icon-btn avatar-btn" aria-haspopup="true" aria-expanded="false" aria-label="ç”¨æˆ·èœå•">
                <img class="user-avatar-small" src="{% if user.usersetting.avatar_url %}{{ user.usersetting.avatar_url }}{% else %}{{ user.email|cravatar:80 }}{% endif %}" alt="avatar">
            </button>
            <div id="avatarMenu" class="avatar-menu" role="menu" aria-hidden="true">
                <button type="button" id="openInlineSettings" role="menuitem">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.6 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.6a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09c0 .69.4 1.31 1 1.51.61.21 1.28.05 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9c.69 0 1.31.4 1.51 1H21a2 2 0 0 1 0 4h-.09c-.69 0-1.31.4-1.51 1Z"/></svg>
                    <span>ç”¨æˆ·è®¾ç½®</span>
                </button>
                <div class="menu-divider" role="separator"></div>
                <button id="avatarLogoutLink" type="button" role="menuitem">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    <span>é€€å‡ºç™»å½•</span>
                </button>
            </div>
        </div>
    </header>
    {% else %}
    <header class="chat-header login-prompt">
        <div class="brand">
            <img src="{% static 'img/icon/TakagiW.webp' %}" alt="Takagi">
        </div>
        <div class="header-spacer"></div>
        <span><a href="{% url 'login' %}">ç™»å½•</a> / <a href="{% url 'register' %}">æ³¨å†Œ</a></span>
    </header>
    {% endif %}

    <main class="chat-main-content">
        <!-- Fallback content for when history is closed -->
        <div class="main-background-view">
            <img src="{% static 'img/Takagi/TakagiOlive.webp' %}" alt="Takagi background" class="main-character-image">
             <div class="response-preview" style="position:absolute; bottom:18%; left:50%; transform:translateX(-50%); width:min(900px,92%); padding:12px 16px 8px; border-radius:16px; background:linear-gradient(135deg, rgba(128,128,128,0.55), rgba(80,80,80,0.45)); backdrop-filter:blur(10px); box-shadow:0 4px 18px -6px rgba(0,0,0,.4); pointer-events:none;">
                <b style="color: white; text-shadow: 0.5px 0.5px 0.5px rgb(255, 122, 144);">é«˜æœ¨:</b>
                <p id="returnMsg" style="color: white; text-shadow: 0.5px 0.5px 0.5px rgb(255, 122, 144);">...</p>
             </div>
        </div>
    </main>

    <aside id="chatHistoryPanel" class="chat-history-panel" aria-hidden="true">
        <ul class="messages-list">
            {% for chat_pair in chat_pairs %}
                <li class="message sent">
                    <div class="message-text" title="{{ user.username }}">
                        <div class="message-sender">
                            <img src="{% if user.usersetting.avatar_url %}{{ user.usersetting.avatar_url }}{% else %}{{ user.email|cravatar:80 }}{% endif %}" alt="{{ user.username }}">
                        </div>
                        <div class="message-content">
                            {{ chat_pair.user_message.content }}
                        </div>
                    </div>
                </li>
                <li class="message received">
                    <div class="message-text">
                        <div class="message-sender">
                            <img src="{% static 'img/icon/TakagiW.webp' %}" alt="Takagi">
                        </div>
                        <div class="message-content">
                            {{ chat_pair.assistant_response.content }}
                        </div>
                    </div>
                </li>
            {% empty %}
                <li class="no-messages" style="text-align: center; color: #888; padding: 20px;">
                    è¿˜æ²¡æœ‰èŠå¤©è®°å½•ï¼Œå¼€å§‹ä½ çš„ç¬¬ä¸€æ¬¡å¯¹è¯å§ï¼
                </li>
            {% endfor %}
        </ul>
    </aside>

    <form class="message-form">
        {%csrf_token%}
        <div class="input-group">
            <input type="text" class="form-control message-input" placeholder="åœ¨æ­¤è¾“å…¥ä½ çš„æé—®..." aria-label="message input">
            <button type="submit" class="btn btn-primary btn-send">å‘é€</button>
        </div>
    </form>

    <!-- Inline User Settings Modal -->
    <div id="inlineUserSettings" class="inline-settings-panel">
        <div class="settings-header">
            <h5>ç”¨æˆ·è®¾ç½®</h5>
            <button type="button" id="closeInlineSettings" class="close-btn" aria-label="å…³é—­">
                <svg width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <form id="inlineSettingsForm">
            {% if not request.user.is_superuser and not user.usersetting.user_api_key %}
            <div class="form-group">
                <label>æ¯æ—¥å¯¹è¯é¢åº¦</label>
                {% widthratio user.usersetting.daily_message_count 50 100 as width_percentage %}
                <div class="progress" style="height: 20px; margin-bottom: 4px; background-color: #e9ecef; border-radius: 4px; overflow: hidden;">
                    <div class="progress-bar" role="progressbar" style="width: {{ width_percentage }}%; background-color: #007bff; height: 100%; transition: width 0.3s ease;" aria-valuenow="{{ user.usersetting.daily_message_count }}" aria-valuemin="0" aria-valuemax="50"></div>
                </div>
                <small class="form-text text-muted" style="font-size: 12px; color: #6c757d; display: block;">{{ user.usersetting.daily_message_count }}/50 æ¡</small>
            </div>
            {% endif %}
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
            <div class="form-group">
                <label for="settings-nickname">æ˜µç§°</label>
                <input id="settings-nickname" name="nickname" class="form-control" value="{{ user.username }}" maxlength="150" />
            </div>
            <div class="form-group">
                <label for="settings-modelName">æ¨¡å‹åç§°</label>
                <input id="settings-modelName" name="modelName" class="form-control" value="{{ user.usersetting.modelName|default:'' }}" placeholder="ä¾‹å¦‚ deepseek-chat" />
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="settings-api-key">è‡ªå®šä¹‰ API Key</label>
                    <input id="settings-api-key" name="user_api_key" class="form-control" value="{{ user.usersetting.user_api_key|default:'' }}" placeholder="sk-..." />
                </div>
                <div class="form-group">
                    <label for="settings-base-url">è‡ªå®šä¹‰ Base URL</label>
                    <input id="settings-base-url" name="user_base_url" class="form-control" value="{{ user.usersetting.user_base_url|default:'' }}" placeholder="ä¾‹å¦‚ https://api.deepseek.com/v1" />
                </div>
            </div>
            <div class="form-group">
                <label for="settings-avatar-url">å¤´åƒå›¾ç‰‡ URL</label>
                <input id="settings-avatar-url" name="avatar_url" class="form-control" value="{{ user.usersetting.avatar_url|default:'' }}" placeholder="https://.../avatar.png" />
                <small class="form-text text-muted" style="font-size: 12px; color: var(--color-text-secondary); margin-top: 4px; display: block;">ç•™ç©ºåˆ™ä½¿ç”¨ Cravatar é‚®ç®±å¤´åƒã€‚</small>
            </div>
            
            <!-- è¯­éŸ³åˆæˆè®¾ç½® -->
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <input type="checkbox" id="settings-tts-enabled" name="tts_enabled" {% if user.usersetting.tts_enabled %}checked{% endif %} style="margin: 0;">
                    <span>å¯ç”¨è¯­éŸ³åˆæˆ</span>
                </label>
                <div id="tts-settings-panel" style="margin-left: 20px; {% if not user.usersetting.tts_enabled %}display: none;{% endif %}">
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label for="settings-tts-api-url" style="font-size: 13px; margin-bottom: 3px;">TTS APIåœ°å€</label>
                        <input id="settings-tts-api-url" name="tts_api_url" class="form-control" 
                               value="{{ user.usersetting.tts_api_url|default:'' }}" 
                               placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤" 
                               style="padding: 4px 6px; font-size: 13px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label for="settings-tts-language" style="font-size: 13px; margin-bottom: 3px;">è¯­è¨€</label>
                        <select id="settings-tts-language" name="tts_language" class="form-control" style="padding: 4px 6px; font-size: 13px;">
                            <option value="ä¸­æ–‡" {% if user.usersetting.tts_language == 'ä¸­æ–‡' %}selected{% endif %}>ä¸­æ–‡</option>
                            <option value="æ—¥è¯­" {% if user.usersetting.tts_language == 'æ—¥è¯­' %}selected{% endif %}>æ—¥è¯­</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label for="settings-tts-noise-scale" style="font-size: 13px; margin-bottom: 3px;">éŸ³é¢‘å™ªéŸ³ (<span id="noise-scale-value">{{ user.usersetting.tts_noise_scale|default:0.6 }}</span>)</label>
                        <input type="range" id="settings-tts-noise-scale" name="tts_noise_scale" 
                               class="form-control" min="0.1" max="1.0" step="0.1" 
                               value="{{ user.usersetting.tts_noise_scale|default:0.6 }}" 
                               style="height: 4px; background: #ddd; outline: none; border-radius: 2px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label for="settings-tts-noise-scale-w" style="font-size: 13px; margin-bottom: 3px;">å™ªéŸ³æƒé‡ (<span id="noise-scale-w-value">{{ user.usersetting.tts_noise_scale_w|default:0.668 }}</span>)</label>
                        <input type="range" id="settings-tts-noise-scale-w" name="tts_noise_scale_w" 
                               class="form-control" min="0.1" max="1.0" step="0.001" 
                               value="{{ user.usersetting.tts_noise_scale_w|default:0.668 }}" 
                               style="height: 4px; background: #ddd; outline: none; border-radius: 2px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label for="settings-tts-length-scale" style="font-size: 13px; margin-bottom: 3px;">é•¿åº¦ç¼©æ”¾ (<span id="length-scale-value">{{ user.usersetting.tts_length_scale|default:1.2 }}</span>)</label>
                        <input type="range" id="settings-tts-length-scale" name="tts_length_scale" 
                               class="form-control" min="0.5" max="2.0" step="0.1" 
                               value="{{ user.usersetting.tts_length_scale|default:1.2 }}" 
                               style="height: 4px; background: #ddd; outline: none; border-radius: 2px;">
                    </div>
                </div>
            </div>
            
            <div class="settings-footer">
                <!-- é»„è‰²ä¿®æ”¹å¯†ç æŒ‰é’®ï¼Œæ”¾åœ¨ä¿å­˜ä¸Šæ–¹ï¼ˆè§†è§‰ä¸Šé ä¸Šï¼‰ï¼Œä½¿ç”¨ç›¸åŒ btn å°ºå¯¸å¹¶åŠ å˜ä½“ç±» -->
                <button type="button" id="openChangePwdInline" class="btn btn-primary btn-change-pwd">ä¿®æ”¹å¯†ç </button>
                <button type="submit" class="btn btn-primary">ä¿å­˜æ›´æ”¹</button>
                <span id="inlineSettingMsg" class="save-msg">å·²ä¿å­˜</span>
            </div>
        </form>
        <!-- Version display in bottom right corner -->
        <div class="version-display">v{{ APP_VERSION }}</div>
    </div>
    <!-- Password change inline modal -->
    <div id="inlineChangePwdModal" class="inline-settings-panel" style="display:none;">
        <div class="settings-header">
            <h5>ä¿®æ”¹å¯†ç </h5>
            <button type="button" id="closeChangePwd" class="close-btn" aria-label="å…³é—­">
                <svg width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <form id="inlineChangePwdForm">
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
            <div class="form-group">
                <label>æ—§å¯†ç </label>
                <input name="old_password" type="password" class="form-control" />
            </div>
            <div class="form-group">
                <label>æ–°å¯†ç </label>
                <input id="inlineNewPwd" name="new_password1" type="password" class="form-control" />
                <div class="pwd-strength" id="inlinePwdStrength">
                    <div class="bar"><i></i></div>
                    <div class="level" id="inlinePwdStrengthText">å¼ºåº¦ï¼š-</div>
                </div>
            </div>
            <div class="form-group">
                <label>å†æ¬¡è¾“å…¥æ–°å¯†ç </label>
                <input name="new_password2" type="password" class="form-control" />
            </div>
            <div class="settings-footer">
                <button type="submit" class="btn btn-primary">ç¡®è®¤ä¿®æ”¹</button>
                <span id="inlineChangePwdMsg" class="save-msg"></span>
            </div>
        </form>
        <!-- Version display in bottom right corner -->
        <div class="version-display">v{{ APP_VERSION }}</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// The existing script block remains largely the same, but with updated element selectors.
// I will replace the selectors and adjust logic where the HTML structure has changed.
(function() {
    const messagesList = document.querySelector('.messages-list');
    const messageForm = document.querySelector('.message-form');
    const messageInput = document.querySelector('.message-input');
    const chatHistoryPanel = document.getElementById('chatHistoryPanel');
    const responsePreview = document.querySelector('.response-preview #returnMsg');
    const chatHistoryButton = document.getElementById('chatHistoryButton');
    const mainContent = document.querySelector('.chat-main-content');

    function scrollToBottom() {
        // The scrollable element is now the messages-list itself
        if (chatHistoryPanel.classList.contains('open')) {
            messagesList.scrollTop = messagesList.scrollHeight;
        }
    }
    // Initial scroll
    window.addEventListener('load', () => {
        setTimeout(scrollToBottom, 100);
        // Add TTS buttons to existing AI messages
        addTTSToExistingMessages();
    });

    function addTTSToExistingMessages() {
        fetch("{% url 'get_tts_settings' %}")
        .then(r => r.json())
        .then(data => {
            if (data.ok && data.settings.enabled) {
                const receivedMessages = document.querySelectorAll('.message.received .message-content');
                receivedMessages.forEach(messageElement => {
                    const text = messageElement.textContent;
                    if (text && text.trim()) {
                        addTTSButton(messageElement.parentElement, text);
                    }
                });
            }
        })
        .catch(e => console.error('è·å–TTSè®¾ç½®å¤±è´¥:', e));
    }


    let ws = null;
    function initWS(){
        if (ws) return;
        try {
            const proto = window.location.protocol === 'https:' ? 'wss' : 'ws';
            ws = new WebSocket(`${proto}://${window.location.host}/ws/chat/`);
            
            ws.onmessage = (ev) => {
                try {
                    const data = JSON.parse(ev.data);
                    if(data.delta){
                        currentReplyBuffer.textContent += data.delta;
                        if(responsePreview) responsePreview.textContent = currentReplyBuffer.textContent;
                        scrollToBottom();
                    } else if(data.done){
                        currentReplyBuffer = null;
                    } else if(data.error){
                        fallbackPost(lastUserMessage, true, data.error);
                    }
                } catch(e){ console.error("WS message parse error:", e); }
            };
            ws.onclose = () => { ws = null; };
            ws.onerror = () => { ws = null; };
        } catch(e) {
            ws = null;
            console.error("WS connection failed:", e);
        }
    }

    const isAuthenticated = '{{ user.is_authenticated }}' === 'True';
    if (isAuthenticated) {
        initWS();
    }

    let currentReplyBuffer = null;
    let lastUserMessage = '';

    function fallbackPost(message, appendError, errText){
        fetch("{% url 'chatbot' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
                'csrfmiddlewaretoken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'message': message
            })
        }).then(r => r.json()).then(data => {
            const response = (appendError && errText ? `[WSå¤±è´¥:${errText}] ` : '') + data.response;
            if(currentReplyBuffer) { currentReplyBuffer.textContent = response; }
            if(responsePreview) responsePreview.textContent = response;
            scrollToBottom();
            currentReplyBuffer = null;
        }).catch(err => console.error("Fallback POST error:", err));
    }

    if (messageForm) {
        messageForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const message = messageInput.value.trim();
            if(!message) return;
            lastUserMessage = message;

            const userAvatar = "{% if user.usersetting.avatar_url %}{{ user.usersetting.avatar_url }}{% else %}{{ user.email|cravatar:80 }}{% endif %}";
            
            // Add user message bubble
            const sentItem = document.createElement('li');
            sentItem.className = 'message sent';
            sentItem.innerHTML = `
                <div class="message-text" title="{{ user.username }}">
                    <div class="message-sender"><img src="${userAvatar}" alt="{{ user.username }}"></div>
                    <div class="message-content"></div>
                </div>`;
            sentItem.querySelector('.message-content').textContent = message;
            messagesList.appendChild(sentItem);

            // Add AI reply placeholder
            const receivedItem = document.createElement('li');
            receivedItem.className = 'message received';
            receivedItem.innerHTML = `
                <div class="message-text">
                    <div class="message-sender"><img src="{% static 'img/icon/TakagiW.webp' %}" alt="Takagi"></div>
                    <div class="message-content"></div>
                </div>`;
            messagesList.appendChild(receivedItem);
            
            currentReplyBuffer = receivedItem.querySelector('.message-content');
            currentReplyBuffer.textContent = '';
            if(responsePreview) responsePreview.textContent = '...';
            
            scrollToBottom();
            messageInput.value='';

            if(ws && ws.readyState === WebSocket.OPEN){
                ws.send(JSON.stringify({message}));
            } else {
                // Try to re-init WS and then send, or fallback
                initWS();
                setTimeout(() => {
                    if(ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({message}));
                    } else {
                        fallbackPost(message, false);
                    }
                }, 100);
            }
        });
    }

    // Modified WebSocket message handler to support TTS
    function initWS(){
        if (ws) return;
        try {
            const proto = window.location.protocol === 'https:' ? 'wss' : 'ws';
            ws = new WebSocket(`${proto}://${window.location.host}/ws/chat/`);
            
            ws.onmessage = (ev) => {
                try {
                    const data = JSON.parse(ev.data);
                    if(data.delta){
                        currentReplyBuffer.textContent += data.delta;
                        if(responsePreview) responsePreview.textContent = currentReplyBuffer.textContent;
                        scrollToBottom();
                    } else if(data.done){
                        // Check if TTS is enabled and add TTS button
                        if (data.tts_enabled && data.final_text) {
                            addTTSButton(currentReplyBuffer.parentElement, data.final_text);
                        }
                        currentReplyBuffer = null;
                    } else if(data.error){
                        fallbackPost(lastUserMessage, true, data.error);
                    }
                } catch(e){ console.error("WS message parse error:", e); }
            };
            ws.onclose = () => { ws = null; };
            ws.onerror = () => { ws = null; };
        } catch(e) {
            ws = null;
            console.error("WS connection failed:", e);
        }
    }

    function checkAndAddTTSButton(messageElement) {
        // Check if TTS is enabled for current user
        fetch("{% url 'get_tts_settings' %}")
        .then(r => r.json())
        .then(data => {
            if (data.ok && data.settings.enabled) {
                const text = messageElement.textContent;
                if (text && text.trim()) {
                    addTTSButton(messageElement.parentElement, text);
                }
            }
        })
        .catch(e => console.error('è·å–TTSè®¾ç½®å¤±è´¥:', e));
    }

    function fallbackPost(message, appendError, errText){
        fetch("{% url 'chatbot' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
                'csrfmiddlewaretoken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'message': message
            })
        }).then(r => r.json()).then(data => {
            const response = (appendError && errText ? `[WSå¤±è´¥:${errText}] ` : '') + data.response;
            if(currentReplyBuffer) { 
                currentReplyBuffer.textContent = response; 
                checkAndAddTTSButton(currentReplyBuffer);
            }
            if(responsePreview) responsePreview.textContent = response;
            scrollToBottom();
            currentReplyBuffer = null;
        }).catch(err => console.error("Fallback POST error:", err));
    }

    if (chatHistoryButton) {
        chatHistoryButton.addEventListener('click', function () {
            const isOpening = !chatHistoryPanel.classList.contains('open');
            this.setAttribute('aria-expanded', isOpening);
            chatHistoryPanel.setAttribute('aria-hidden', !isOpening);
            chatHistoryPanel.classList.toggle('open');
            mainContent.style.display = isOpening ? 'none' : 'block';
            document.body.classList.toggle('no-scroll-overlay', isOpening);
            if (isOpening) {
                scrollToBottom();
            }
        });
    }

    // --- Avatar Menu & Settings Modal Logic ---
    const avatarToggle = document.getElementById('avatarMenuToggle');
    const avatarMenu = document.getElementById('avatarMenu');
    const inlinePanel = document.getElementById('inlineUserSettings');
    const openInlineBtn = document.getElementById('openInlineSettings');
    const closeInlineBtn = document.getElementById('closeInlineSettings');
    const inlineForm = document.getElementById('inlineSettingsForm');
    const inlineMsg = document.getElementById('inlineSettingMsg');
    const logoutLink = document.getElementById('avatarLogoutLink');

    function closeAllPopups() {
        if (avatarMenu) {
            avatarMenu.classList.remove('open');
            avatarMenu.setAttribute('aria-hidden', 'true');
            avatarToggle.setAttribute('aria-expanded', 'false');
        }
        if (inlinePanel) {
            inlinePanel.style.display = 'none';
        }
        // å…³é—­ä¿®æ”¹å¯†ç æµ®çª—å¹¶æ¸…ç†ä¿¡æ¯
        if (changePwdModal) {
            changePwdModal.style.display = 'none';
            if (changePwdMsg) { changePwdMsg.textContent = ''; changePwdMsg.classList.remove('text-success','text-danger'); }
        }
    }

    if (avatarToggle) {
        avatarToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpening = !avatarMenu.classList.contains('open');
            closeAllPopups();
            if (isOpening) {
                avatarMenu.classList.add('open');
                avatarMenu.setAttribute('aria-hidden', 'false');
                avatarToggle.setAttribute('aria-expanded', 'true');
            }
        });
    }

    if (openInlineBtn) {
        openInlineBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            closeAllPopups();
            inlinePanel.style.display = 'block';
        });
    }
    
    if (closeInlineBtn) {
        closeInlineBtn.addEventListener('click', closeAllPopups);
    }

    if (logoutLink) {
        logoutLink.addEventListener('click', () => {
            if (confirm('ç¡®è®¤é€€å‡ºç™»å½•ï¼Ÿ')) {
                window.location.href = "{% url 'logout' %}";
            }
        });
    }

    // Inline change password modal logic
    const openChangePwdBtn = document.getElementById('openChangePwdInline');
    const changePwdModal = document.getElementById('inlineChangePwdModal');
    const closeChangePwdBtn = document.getElementById('closeChangePwd');
    const changePwdForm = document.getElementById('inlineChangePwdForm');
    const changePwdMsg = document.getElementById('inlineChangePwdMsg');

    if (openChangePwdBtn) {
        openChangePwdBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            closeAllPopups();
        changePwdModal.style.display = 'block';
        // æ¸…é™¤æ—§çš„æ¶ˆæ¯å¹¶èšç„¦ç¬¬ä¸€ä¸ªè¾“å…¥
        if (changePwdMsg) { changePwdMsg.textContent = ''; changePwdMsg.classList.remove('text-success','text-danger'); }
        const firstInput = changePwdModal.querySelector('input[type="password"]');
        if (firstInput) firstInput.focus();
        });
    }
    if (closeChangePwdBtn) closeChangePwdBtn.addEventListener('click', () => { closeAllPopups(); });
    if (changePwdForm) {
        changePwdForm.addEventListener('submit', function(e){
            e.preventDefault();
            changePwdMsg.textContent = '';
            const fd = new FormData(changePwdForm);
            fetch('{% url "inline_change_password" %}', { method: 'POST', body: fd })
            .then(r=>r.json()).then(j=>{
                if(j.ok){
                    changePwdMsg.textContent = 'å·²ä¿®æ”¹';
                    changePwdMsg.classList.remove('text-danger');
                    changePwdMsg.classList.add('text-success');
                    setTimeout(()=>{ changePwdModal.style.display='none'; changePwdMsg.textContent=''; }, 1200);
                } else {
                    changePwdMsg.textContent = j.error || 'ä¿®æ”¹å¤±è´¥';
                    changePwdMsg.classList.remove('text-success');
                    changePwdMsg.classList.add('text-danger');
                }
            }).catch(()=>{
                changePwdMsg.textContent = 'ç½‘ç»œé”™è¯¯';
                changePwdMsg.classList.remove('text-success');
                changePwdMsg.classList.add('text-danger');
            });
        });
    }

    // Password strength meter for inline modal
    const inlineNewPwd = document.getElementById('inlineNewPwd');
    const inlinePwdBar = document.querySelector('#inlinePwdStrength .bar > i');
    const inlinePwdText = document.getElementById('inlinePwdStrengthText');

    function calcPwdStrength(pwd){
        let score = 0;
        if (!pwd) return {score:0, label:'-' };
        if (pwd.length >= 8) score += 1;
        if (pwd.length >= 12) score += 1;
        if (/[a-z]/.test(pwd) && /[A-Z]/.test(pwd)) score += 1;
        if (/[0-9]/.test(pwd)) score += 1;
        if (/[^A-Za-z0-9]/.test(pwd)) score += 1;
        let label = 'æå¼±';
        if (score <= 1) label = 'æå¼±';
        else if (score == 2) label = 'è¾ƒå¼±';
        else if (score == 3) label = 'ä¸€èˆ¬';
        else if (score == 4) label = 'è¾ƒå¼º';
        else label = 'å¾ˆå¼º';
        return {score, label};
    }

    if (inlineNewPwd) {
        inlineNewPwd.addEventListener('input', function(){
            const v = inlineNewPwd.value || '';
            const {score, label} = calcPwdStrength(v);
            const pct = Math.min(100, Math.round((score / 5) * 100));
            if (inlinePwdBar) inlinePwdBar.style.width = pct + '%';
            if (inlinePwdText) inlinePwdText.textContent = 'å¼ºåº¦ï¼š' + label;
            // color gradient from orange to green
            if (inlinePwdBar) inlinePwdBar.style.background = score >=4 ? 'linear-gradient(90deg,#10b981,#059669)' : (score>=2 ? 'linear-gradient(90deg,#f97316,#f59e0b)' : 'linear-gradient(90deg,#f97316,#f97316)');
        });
    }

    document.addEventListener('click', (e) => {
        if (avatarMenu && !avatarMenu.contains(e.target) && !avatarToggle.contains(e.target) &&
            inlinePanel && !inlinePanel.contains(e.target) &&
            changePwdModal && !changePwdModal.contains(e.target)) {
            closeAllPopups();
        }
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeAllPopups();
    });

    if (inlineForm) {
        inlineForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(inlineForm);
            
            // æ·»åŠ TTSè®¾ç½®åˆ°è¡¨å•æ•°æ®
            formData.set('tts_enabled', ttsEnabledCheckbox?.checked ? 'true' : 'false');
            if (ttsEnabledCheckbox?.checked) {
                formData.set('tts_api_url', document.getElementById('settings-tts-api-url')?.value || '');
                formData.set('tts_language', document.getElementById('settings-tts-language')?.value || 'ä¸­æ–‡');
                formData.set('tts_noise_scale', document.getElementById('settings-tts-noise-scale')?.value || '0.6');
                formData.set('tts_noise_scale_w', document.getElementById('settings-tts-noise-scale-w')?.value || '0.668');
                formData.set('tts_length_scale', document.getElementById('settings-tts-length-scale')?.value || '1.2');
            }
            
            fetch("{% url 'user_settings_update' %}", { method: 'POST', body: formData })
            .then(r => r.json())
            .then(d => {
                inlineMsg.classList.remove('text-danger');
                inlineMsg.classList.add('text-success');
                if (d.ok) {
                    inlineMsg.textContent = 'å·²ä¿å­˜';
                    inlineMsg.style.display = 'inline';
                    setTimeout(() => { inlineMsg.style.display = 'none'; }, 2000);
                    
                    if (d.nickname) {
                        const brandSpan = document.querySelector('.brand span');
                        if (brandSpan) brandSpan.textContent = 'æ¬¢è¿, ' + d.nickname;
                    }
                    if (d.avatar) {
                        const avatarImgs = document.querySelectorAll('.user-avatar-small, .message.sent .message-sender img');
                        avatarImgs.forEach(img => img.src = d.avatar);
                    }
                } else {
                    inlineMsg.textContent = d.error || 'ä¿å­˜å¤±è´¥';
                    inlineMsg.style.display = 'inline';
                    inlineMsg.classList.remove('text-success');
                    inlineMsg.classList.add('text-danger');
                }
            }).catch(() => {
                inlineMsg.textContent = 'ç½‘ç»œé”™è¯¯';
                inlineMsg.style.display = 'inline';
                inlineMsg.classList.remove('text-success');
                inlineMsg.classList.add('text-danger');
            });
        });
    }

    // TTS settings toggle
    const ttsEnabledCheckbox = document.getElementById('settings-tts-enabled');
    const ttsSettingsPanel = document.getElementById('tts-settings-panel');
    const noiseScaleSlider = document.getElementById('settings-tts-noise-scale');
    const noiseScaleValue = document.getElementById('noise-scale-value');
    const noiseScaleWSlider = document.getElementById('settings-tts-noise-scale-w');
    const noiseScaleWValue = document.getElementById('noise-scale-w-value');
    const lengthScaleSlider = document.getElementById('settings-tts-length-scale');
    const lengthScaleValue = document.getElementById('length-scale-value');

    if (ttsEnabledCheckbox && ttsSettingsPanel) {
        ttsEnabledCheckbox.addEventListener('change', function() {
            ttsSettingsPanel.style.display = this.checked ? 'block' : 'none';
        });
    }

    // Update slider values display
    if (noiseScaleSlider && noiseScaleValue) {
        noiseScaleSlider.addEventListener('input', function() {
            noiseScaleValue.textContent = this.value;
        });
    }
    if (noiseScaleWSlider && noiseScaleWValue) {
        noiseScaleWSlider.addEventListener('input', function() {
            noiseScaleWValue.textContent = this.value;
        });
    }
    if (lengthScaleSlider && lengthScaleValue) {
        lengthScaleSlider.addEventListener('input', function() {
            lengthScaleValue.textContent = this.value;
        });
    }

    // Current audio player for TTS
    let currentAudio = null;

    function playTTSAudio(audioUrl) {
        try {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            currentAudio = new Audio(audioUrl);
            currentAudio.play().catch(e => {
                console.error('æ’­æ”¾éŸ³é¢‘å¤±è´¥:', e);
                alert('æ’­æ”¾éŸ³é¢‘å¤±è´¥');
            });
        } catch (e) {
            console.error('åˆ›å»ºéŸ³é¢‘å¯¹è±¡å¤±è´¥:', e);
            alert('æ’­æ”¾éŸ³é¢‘å¤±è´¥');
        }
    }

    function showTTSLoader(messageElement) {
        const loaderDiv = document.createElement('div');
        loaderDiv.className = 'tts-loader';
        loaderDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px; font-size: 12px; color: #666;">
                <div class="spinner" style="width: 12px; height: 12px; border: 2px solid #ddd; border-top: 2px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <span>æ­£åœ¨ç”Ÿæˆè¯­éŸ³...</span>
            </div>
        `;
        messageElement.appendChild(loaderDiv);
        return loaderDiv;
    }

    function addTTSButton(messageElement, text) {
        const buttonDiv = document.createElement('div');
        buttonDiv.innerHTML = `
            <button class="tts-play-btn" style="margin-top: 8px; padding: 4px 8px; font-size: 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                ğŸ”Š æ’­æ”¾è¯­éŸ³
            </button>
        `;
        const button = buttonDiv.querySelector('.tts-play-btn');
        button.addEventListener('click', function() {
            generateAndPlayTTS(text, messageElement);
        });
        messageElement.appendChild(buttonDiv);
    }

    function generateAndPlayTTS(text, messageElement) {
        const loader = showTTSLoader(messageElement);
        
        fetch("{% url 'generate_tts_audio' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
                'csrfmiddlewaretoken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'text': text
            })
        })
        .then(r => r.json())
        .then(data => {
            loader.remove();
            if (data.ok && data.audio_url) {
                playTTSAudio(data.audio_url);
            } else {
                alert('è¯­éŸ³ç”Ÿæˆå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(err => {
            loader.remove();
            console.error('TTSè¯·æ±‚å¤±è´¥:', err);
            alert('è¯­éŸ³ç”Ÿæˆå¤±è´¥');
        });
    }
})();
</script>
{% endblock %}