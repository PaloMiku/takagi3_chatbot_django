{% extends 'base.html' %}
{% load static avatar_extras %}
{% block title %}AI Takagi{% endblock %}

{% block bootstrap_css %}{% endblock %}
{% block bootstrap_scripts %}{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}">
{% endblock %}


{% block content %}
<div class="chat-container">
    {% if user.is_authenticated %}
    <header class="chat-header">
        <div class="brand">
            <img src="{% static 'img/icon/TakagiW.webp' %}" alt="Takagi">
            <span>欢迎, {{ user.username }}</span>
        </div>
        <div class="header-spacer"></div>
        <button id="chatHistoryButton" class="icon-btn" aria-expanded="false" aria-controls="chatHistoryPanel" aria-label="聊天记录" title="聊天记录">
            <svg viewBox="0 0 24 24" role="img" aria-hidden="true"><path fill="currentColor" d="M4 4h16v12H5.17L4 17.17V4m0-2a2 2 0 0 0-2 2v18l4-4h14a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H4Z"/></svg>
        </button>
        <div class="avatar-wrapper" style="position:relative;">
            <button id="avatarMenuToggle" class="icon-btn avatar-btn" aria-haspopup="true" aria-expanded="false" aria-label="用户菜单">
                <img class="user-avatar-small" src="{% if user.usersetting.avatar_url %}{{ user.usersetting.avatar_url }}{% else %}{{ user.email|cravatar:80 }}{% endif %}" alt="avatar">
            </button>
            <div id="avatarMenu" class="avatar-menu" role="menu" aria-hidden="true">
                <button type="button" id="openInlineSettings" role="menuitem">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.6 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.6a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09c0 .69.4 1.31 1 1.51.61.21 1.28.05 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9c.69 0 1.31.4 1.51 1H21a2 2 0 0 1 0 4h-.09c-.69 0-1.31.4-1.51 1Z"/></svg>
                    <span>用户设置</span>
                </button>
                <div class="menu-divider" role="separator"></div>
                <button id="avatarLogoutLink" type="button" role="menuitem">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    <span>退出登录</span>
                </button>
            </div>
        </div>
    </header>
    {% else %}
    <header class="chat-header login-prompt">
        <div class="brand">
            <img src="{% static 'img/icon/TakagiW.webp' %}" alt="Takagi">
        </div>
        <div class="header-spacer"></div>
        <span><a href="{% url 'login' %}">登录</a> / <a href="{% url 'register' %}">注册</a></span>
    </header>
    {% endif %}

    <main class="chat-main-content">
        <!-- Fallback content for when history is closed -->
        <div class="main-background-view">
            <img src="{% static 'img/Takagi/TakagiOlive.webp' %}" alt="Takagi background" class="main-character-image">
             <div class="response-preview" style="position:absolute; bottom:18%; left:50%; transform:translateX(-50%); width:min(900px,92%); padding:12px 16px 8px; border-radius:16px; background:linear-gradient(135deg, rgba(128,128,128,0.55), rgba(80,80,80,0.45)); backdrop-filter:blur(10px); box-shadow:0 4px 18px -6px rgba(0,0,0,.4); pointer-events:none;">
                <b style="color: white; text-shadow: 0.5px 0.5px 0.5px rgb(255, 122, 144);">高木:</b>
                <p id="returnMsg" style="color: white; text-shadow: 0.5px 0.5px 0.5px rgb(255, 122, 144);">...</p>
             </div>
        </div>
    </main>

    <aside id="chatHistoryPanel" class="chat-history-panel" aria-hidden="true">
        <ul class="messages-list">
            {% for chat_pair in chat_pairs %}
                <li class="message sent">
                    <div class="message-text" title="{{ user.username }}">
                        <div class="message-sender">
                            <img src="{% if user.usersetting.avatar_url %}{{ user.usersetting.avatar_url }}{% else %}{{ user.email|cravatar:80 }}{% endif %}" alt="{{ user.username }}">
                        </div>
                        <div class="message-content">
                            {{ chat_pair.user_message.content }}
                        </div>
                    </div>
                </li>
                <li class="message received">
                    <div class="message-text">
                        <div class="message-sender">
                            <img src="{% static 'img/icon/TakagiW.webp' %}" alt="Takagi">
                        </div>
                        <div class="message-content">
                            {{ chat_pair.assistant_response.content }}
                        </div>
                    </div>
                </li>
            {% empty %}
                <li class="no-messages" style="text-align: center; color: #888; padding: 20px;">
                    还没有聊天记录，开始你的第一次对话吧！
                </li>
            {% endfor %}
        </ul>
    </aside>

    <form class="message-form">
        {%csrf_token%}
        <div class="input-group">
            <input type="text" class="form-control message-input" placeholder="在此输入你的提问..." aria-label="message input">
            <button type="submit" class="btn btn-primary btn-send">发送</button>
        </div>
    </form>

    <!-- Inline User Settings Modal -->
    <div id="inlineUserSettings" class="inline-settings-panel">
        <div class="settings-header">
            <h5>用户设置</h5>
            <button type="button" id="closeInlineSettings" class="close-btn" aria-label="关闭">
                <svg width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <form id="inlineSettingsForm">
            {% if not request.user.is_superuser and not user.usersetting.user_api_key %}
            <div class="form-group">
                <label>每日对话额度</label>
                {% widthratio user.usersetting.daily_message_count 50 100 as width_percentage %}
                <div class="progress" style="height: 20px; margin-bottom: 4px; background-color: #e9ecef; border-radius: 4px; overflow: hidden;">
                    <div class="progress-bar" role="progressbar" style="width: {{ width_percentage }}%; background-color: #007bff; height: 100%; transition: width 0.3s ease;" aria-valuenow="{{ user.usersetting.daily_message_count }}" aria-valuemin="0" aria-valuemax="50"></div>
                </div>
                <small class="form-text text-muted" style="font-size: 12px; color: #6c757d; display: block;">{{ user.usersetting.daily_message_count }}/50 条</small>
            </div>
            {% endif %}
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
            <div class="form-group">
                <label for="settings-nickname">昵称</label>
                <input id="settings-nickname" name="nickname" class="form-control" value="{{ user.username }}" maxlength="150" />
            </div>
            <div class="form-group">
                <label for="settings-modelName">模型名称</label>
                <input id="settings-modelName" name="modelName" class="form-control" value="{{ user.usersetting.modelName|default:'' }}" placeholder="例如 deepseek-chat" />
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="settings-api-key">自定义 API Key</label>
                    <input id="settings-api-key" name="user_api_key" class="form-control" value="{{ user.usersetting.user_api_key|default:'' }}" placeholder="sk-..." />
                </div>
                <div class="form-group">
                    <label for="settings-base-url">自定义 Base URL</label>
                    <input id="settings-base-url" name="user_base_url" class="form-control" value="{{ user.usersetting.user_base_url|default:'' }}" placeholder="例如 https://api.deepseek.com/v1" />
                </div>
            </div>
            <div class="form-group">
                <label for="settings-avatar-url">头像图片 URL</label>
                <input id="settings-avatar-url" name="avatar_url" class="form-control" value="{{ user.usersetting.avatar_url|default:'' }}" placeholder="https://.../avatar.png" />
                <small class="form-text text-muted" style="font-size: 12px; color: var(--color-text-secondary); margin-top: 4px; display: block;">留空则使用 Cravatar 邮箱头像。</small>
            </div>
            <div class="settings-footer">
                <!-- 黄色修改密码按钮，放在保存上方（视觉上靠上），使用相同 btn 尺寸并加变体类 -->
                <button type="button" id="openChangePwdInline" class="btn btn-primary btn-change-pwd">修改密码</button>
                <button type="submit" class="btn btn-primary">保存更改</button>
                <span id="inlineSettingMsg" class="save-msg">已保存</span>
            </div>
        </form>
    </div>
    <!-- Password change inline modal -->
    <div id="inlineChangePwdModal" class="inline-settings-panel" style="display:none;">
        <div class="settings-header">
            <h5>修改密码</h5>
            <button type="button" id="closeChangePwd" class="close-btn" aria-label="关闭">
                <svg width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <form id="inlineChangePwdForm">
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
            <div class="form-group">
                <label>旧密码</label>
                <input name="old_password" type="password" class="form-control" />
            </div>
            <div class="form-group">
                <label>新密码</label>
                <input id="inlineNewPwd" name="new_password1" type="password" class="form-control" />
                <div class="pwd-strength" id="inlinePwdStrength">
                    <div class="bar"><i></i></div>
                    <div class="level" id="inlinePwdStrengthText">强度：-</div>
                </div>
            </div>
            <div class="form-group">
                <label>再次输入新密码</label>
                <input name="new_password2" type="password" class="form-control" />
            </div>
            <div class="settings-footer">
                <button type="submit" class="btn btn-primary">确认修改</button>
                <span id="inlineChangePwdMsg" class="save-msg"></span>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// The existing script block remains largely the same, but with updated element selectors.
// I will replace the selectors and adjust logic where the HTML structure has changed.
(function() {
    const messagesList = document.querySelector('.messages-list');
    const messageForm = document.querySelector('.message-form');
    const messageInput = document.querySelector('.message-input');
    const chatHistoryPanel = document.getElementById('chatHistoryPanel');
    const responsePreview = document.querySelector('.response-preview #returnMsg');
    const chatHistoryButton = document.getElementById('chatHistoryButton');
    const mainContent = document.querySelector('.chat-main-content');

    function scrollToBottom() {
        // The scrollable element is now the messages-list itself
        if (chatHistoryPanel.classList.contains('open')) {
            messagesList.scrollTop = messagesList.scrollHeight;
        }
    }
    // Initial scroll
    window.addEventListener('load', () => {
        setTimeout(scrollToBottom, 100);
    });


    let ws = null;
    function initWS(){
        if (ws) return;
        try {
            const proto = window.location.protocol === 'https:' ? 'wss' : 'ws';
            ws = new WebSocket(`${proto}://${window.location.host}/ws/chat/`);
            
            ws.onmessage = (ev) => {
                try {
                    const data = JSON.parse(ev.data);
                    if(data.delta){
                        currentReplyBuffer.textContent += data.delta;
                        if(responsePreview) responsePreview.textContent = currentReplyBuffer.textContent;
                        scrollToBottom();
                    } else if(data.done){
                        currentReplyBuffer = null;
                    } else if(data.error){
                        fallbackPost(lastUserMessage, true, data.error);
                    }
                } catch(e){ console.error("WS message parse error:", e); }
            };
            ws.onclose = () => { ws = null; };
            ws.onerror = () => { ws = null; };
        } catch(e) {
            ws = null;
            console.error("WS connection failed:", e);
        }
    }

    const isAuthenticated = '{{ user.is_authenticated }}' === 'True';
    if (isAuthenticated) {
        initWS();
    }

    let currentReplyBuffer = null;
    let lastUserMessage = '';

    function fallbackPost(message, appendError, errText){
        fetch("{% url 'chatbot' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
                'csrfmiddlewaretoken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'message': message
            })
        }).then(r => r.json()).then(data => {
            const response = (appendError && errText ? `[WS失败:${errText}] ` : '') + data.response;
            if(currentReplyBuffer) { currentReplyBuffer.textContent = response; }
            if(responsePreview) responsePreview.textContent = response;
            scrollToBottom();
            currentReplyBuffer = null;
        }).catch(err => console.error("Fallback POST error:", err));
    }

    if (messageForm) {
        messageForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const message = messageInput.value.trim();
            if(!message) return;
            lastUserMessage = message;

            const userAvatar = "{% if user.usersetting.avatar_url %}{{ user.usersetting.avatar_url }}{% else %}{{ user.email|cravatar:80 }}{% endif %}";
            
            // Add user message bubble
            const sentItem = document.createElement('li');
            sentItem.className = 'message sent';
            sentItem.innerHTML = `
                <div class="message-text" title="{{ user.username }}">
                    <div class="message-sender"><img src="${userAvatar}" alt="{{ user.username }}"></div>
                    <div class="message-content"></div>
                </div>`;
            sentItem.querySelector('.message-content').textContent = message;
            messagesList.appendChild(sentItem);

            // Add AI reply placeholder
            const receivedItem = document.createElement('li');
            receivedItem.className = 'message received';
            receivedItem.innerHTML = `
                <div class="message-text">
                    <div class="message-sender"><img src="{% static 'img/icon/TakagiW.webp' %}" alt="Takagi"></div>
                    <div class="message-content"></div>
                </div>`;
            messagesList.appendChild(receivedItem);
            
            currentReplyBuffer = receivedItem.querySelector('.message-content');
            currentReplyBuffer.textContent = '';
            if(responsePreview) responsePreview.textContent = '...';
            
            scrollToBottom();
            messageInput.value='';

            if(ws && ws.readyState === WebSocket.OPEN){
                ws.send(JSON.stringify({message}));
            } else {
                // Try to re-init WS and then send, or fallback
                initWS();
                setTimeout(() => {
                    if(ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({message}));
                    } else {
                        fallbackPost(message, false);
                    }
                }, 100);
            }
        });
    }

    if (chatHistoryButton) {
        chatHistoryButton.addEventListener('click', function () {
            const isOpening = !chatHistoryPanel.classList.contains('open');
            this.setAttribute('aria-expanded', isOpening);
            chatHistoryPanel.setAttribute('aria-hidden', !isOpening);
            chatHistoryPanel.classList.toggle('open');
            mainContent.style.display = isOpening ? 'none' : 'block';
            document.body.classList.toggle('no-scroll-overlay', isOpening);
            if (isOpening) {
                scrollToBottom();
            }
        });
    }

    // --- Avatar Menu & Settings Modal Logic ---
    const avatarToggle = document.getElementById('avatarMenuToggle');
    const avatarMenu = document.getElementById('avatarMenu');
    const inlinePanel = document.getElementById('inlineUserSettings');
    const openInlineBtn = document.getElementById('openInlineSettings');
    const closeInlineBtn = document.getElementById('closeInlineSettings');
    const inlineForm = document.getElementById('inlineSettingsForm');
    const inlineMsg = document.getElementById('inlineSettingMsg');
    const logoutLink = document.getElementById('avatarLogoutLink');

    function closeAllPopups() {
        if (avatarMenu) {
            avatarMenu.classList.remove('open');
            avatarMenu.setAttribute('aria-hidden', 'true');
            avatarToggle.setAttribute('aria-expanded', 'false');
        }
        if (inlinePanel) {
            inlinePanel.style.display = 'none';
        }
        // 关闭修改密码浮窗并清理信息
        if (changePwdModal) {
            changePwdModal.style.display = 'none';
            if (changePwdMsg) { changePwdMsg.textContent = ''; changePwdMsg.classList.remove('text-success','text-danger'); }
        }
    }

    if (avatarToggle) {
        avatarToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpening = !avatarMenu.classList.contains('open');
            closeAllPopups();
            if (isOpening) {
                avatarMenu.classList.add('open');
                avatarMenu.setAttribute('aria-hidden', 'false');
                avatarToggle.setAttribute('aria-expanded', 'true');
            }
        });
    }

    if (openInlineBtn) {
        openInlineBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            closeAllPopups();
            inlinePanel.style.display = 'block';
        });
    }
    
    if (closeInlineBtn) {
        closeInlineBtn.addEventListener('click', closeAllPopups);
    }

    if (logoutLink) {
        logoutLink.addEventListener('click', () => {
            if (confirm('确认退出登录？')) {
                window.location.href = "{% url 'logout' %}";
            }
        });
    }

    // Inline change password modal logic
    const openChangePwdBtn = document.getElementById('openChangePwdInline');
    const changePwdModal = document.getElementById('inlineChangePwdModal');
    const closeChangePwdBtn = document.getElementById('closeChangePwd');
    const changePwdForm = document.getElementById('inlineChangePwdForm');
    const changePwdMsg = document.getElementById('inlineChangePwdMsg');

    if (openChangePwdBtn) {
        openChangePwdBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            closeAllPopups();
        changePwdModal.style.display = 'block';
        // 清除旧的消息并聚焦第一个输入
        if (changePwdMsg) { changePwdMsg.textContent = ''; changePwdMsg.classList.remove('text-success','text-danger'); }
        const firstInput = changePwdModal.querySelector('input[type="password"]');
        if (firstInput) firstInput.focus();
        });
    }
    if (closeChangePwdBtn) closeChangePwdBtn.addEventListener('click', () => { closeAllPopups(); });
    if (changePwdForm) {
        changePwdForm.addEventListener('submit', function(e){
            e.preventDefault();
            changePwdMsg.textContent = '';
            const fd = new FormData(changePwdForm);
            fetch('{% url "inline_change_password" %}', { method: 'POST', body: fd })
            .then(r=>r.json()).then(j=>{
                if(j.ok){
                    changePwdMsg.textContent = '已修改';
                    changePwdMsg.classList.remove('text-danger');
                    changePwdMsg.classList.add('text-success');
                    setTimeout(()=>{ changePwdModal.style.display='none'; changePwdMsg.textContent=''; }, 1200);
                } else {
                    changePwdMsg.textContent = j.error || '修改失败';
                    changePwdMsg.classList.remove('text-success');
                    changePwdMsg.classList.add('text-danger');
                }
            }).catch(()=>{
                changePwdMsg.textContent = '网络错误';
                changePwdMsg.classList.remove('text-success');
                changePwdMsg.classList.add('text-danger');
            });
        });
    }

    // Password strength meter for inline modal
    const inlineNewPwd = document.getElementById('inlineNewPwd');
    const inlinePwdBar = document.querySelector('#inlinePwdStrength .bar > i');
    const inlinePwdText = document.getElementById('inlinePwdStrengthText');

    function calcPwdStrength(pwd){
        let score = 0;
        if (!pwd) return {score:0, label:'-' };
        if (pwd.length >= 8) score += 1;
        if (pwd.length >= 12) score += 1;
        if (/[a-z]/.test(pwd) && /[A-Z]/.test(pwd)) score += 1;
        if (/[0-9]/.test(pwd)) score += 1;
        if (/[^A-Za-z0-9]/.test(pwd)) score += 1;
        let label = '极弱';
        if (score <= 1) label = '极弱';
        else if (score == 2) label = '较弱';
        else if (score == 3) label = '一般';
        else if (score == 4) label = '较强';
        else label = '很强';
        return {score, label};
    }

    if (inlineNewPwd) {
        inlineNewPwd.addEventListener('input', function(){
            const v = inlineNewPwd.value || '';
            const {score, label} = calcPwdStrength(v);
            const pct = Math.min(100, Math.round((score / 5) * 100));
            if (inlinePwdBar) inlinePwdBar.style.width = pct + '%';
            if (inlinePwdText) inlinePwdText.textContent = '强度：' + label;
            // color gradient from orange to green
            if (inlinePwdBar) inlinePwdBar.style.background = score >=4 ? 'linear-gradient(90deg,#10b981,#059669)' : (score>=2 ? 'linear-gradient(90deg,#f97316,#f59e0b)' : 'linear-gradient(90deg,#f97316,#f97316)');
        });
    }

    document.addEventListener('click', (e) => {
        if (avatarMenu && !avatarMenu.contains(e.target) && !avatarToggle.contains(e.target) &&
            inlinePanel && !inlinePanel.contains(e.target) &&
            changePwdModal && !changePwdModal.contains(e.target)) {
            closeAllPopups();
        }
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeAllPopups();
    });

    if (inlineForm) {
        inlineForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(inlineForm);
            fetch("{% url 'user_settings_update' %}", { method: 'POST', body: formData })
            .then(r => r.json())
            .then(d => {
                inlineMsg.classList.remove('text-danger');
                inlineMsg.classList.add('text-success');
                if (d.ok) {
                    inlineMsg.textContent = '已保存';
                    inlineMsg.style.display = 'inline';
                    setTimeout(() => { inlineMsg.style.display = 'none'; }, 2000);
                    
                    if (d.nickname) {
                        const brandSpan = document.querySelector('.brand span');
                        if (brandSpan) brandSpan.textContent = '欢迎, ' + d.nickname;
                    }
                    if (d.avatar) {
                        const avatarImgs = document.querySelectorAll('.user-avatar-small, .message.sent .message-sender img');
                        avatarImgs.forEach(img => img.src = d.avatar);
                    }
                } else {
                    inlineMsg.textContent = d.error || '保存失败';
                    inlineMsg.style.display = 'inline';
                    inlineMsg.classList.remove('text-success');
                    inlineMsg.classList.add('text-danger');
                }
            }).catch(() => {
                inlineMsg.textContent = '网络错误';
                inlineMsg.style.display = 'inline';
                inlineMsg.classList.remove('text-success');
                inlineMsg.classList.add('text-danger');
            });
        });
    }
})();
</script>
{% endblock %}