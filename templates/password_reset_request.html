{% extends 'base.html' %}
{% load static %}

{% block title %}找回密码{% endblock %}

{% block bootstrap_css %}{% endblock %}
{% block bootstrap_scripts %}{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/auth.css' %}">
{% endblock %}

{% block content %}
<div class="auth-wrapper">
  <div class="auth-card">
    <div class="auth-header">
      <h1 class="auth-title">找回密码</h1>
      <p class="auth-sub">我们将向您的邮箱发送验证码</p>
    </div>

    {% if error %}<div class="alert">{{ error }}</div>{% endif %}
    {% if sent %}
      <div class="alert alert-success" style="margin-bottom: 1rem;">已向 <strong>{{ email }}</strong> 发送验证码（5分钟内有效）。请查收邮箱并前往下一步。</div>
    {% endif %}

    <form method="post" id="send-email-form" style="margin-bottom: 1rem;">
      {% csrf_token %}
      <div class="form-group">
        <label for="email">邮箱</label>
        <input type="email" class="form-control" id="email" name="email" value="{{ email }}" required />
      </div>
      <button id="send-code" type="button" class="btn btn-primary">发送验证码</button>
    </form>

    <form method="get" action="{% url 'password_reset_confirm' %}" class="mt-3">
      <input type="hidden" name="email" id="hidden-email-for-confirm" value="{{ email }}" />
      <button class="btn btn-secondary" style="width:100%">我已收到验证码，去重置</button>
    </form>

    <div class="switch-link">
      想起来了？ <a href="{% url 'login' %}">返回登录</a>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sendCodeBtn = document.getElementById('send-code');
    const emailInput = document.querySelector('#send-email-form input[name="email"]');
    const hiddenEmailInput = document.getElementById('hidden-email-for-confirm');
    let isSending = false;

    emailInput.addEventListener('input', () => {
        hiddenEmailInput.value = emailInput.value;
    });

    sendCodeBtn.addEventListener('click', function(){
        if (isSending) return;
        isSending = true;
        sendCodeBtn.disabled = true;
        sendCodeBtn.textContent = '发送中...';

        const form = document.getElementById('send-email-form');
        const data = new FormData(form);
        fetch('{% url "send_reset_code" %}', {
            method: 'POST',
            body: data,
            headers: {'X-CSRFToken': '{{ csrf_token }}'}
        })
        .then(r => r.json())
        .then(j => {
            if(j.ok){
                alert('验证码已发送，请查收');
                // Optionally, refresh to show the 'sent' message
                window.location.search = '?email=' + encodeURIComponent(emailInput.value);
            } else {
                alert('发送失败: ' + (j.error || '未知错误'));
            }
        })
        .finally(() => {
            isSending = false;
            sendCodeBtn.disabled = false;
            sendCodeBtn.textContent = '发送验证码';
        });
    });
});
</script>
{% endblock %}

